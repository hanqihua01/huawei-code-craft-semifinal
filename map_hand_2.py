import sys
import copy

from robot import robot
from worker import worker
from frame_statement import frame_statement
from mission_system import mission_system
from utile import utile

class map:
    def __init__(self):
        self.robot_number = 0
        self.robot_list = [] # store robots

        self.leaf_worker_type = [1,2,3]
        self.end_worker_type = [8, 9]
        self.middle_worker_type = [4,5,6,7]

        self.worker_number = 0
        self.worker_list = [] # store workers
        self.worker_group_list = []
        for i in range(10):
            self.worker_group_list.append([]) # 以组的形式存储每种类型工作台的id，一共9种，第0位空着

        self.frame_number = 0
        self.frame_list = [] # 保存有所有frame statement的列表

        self.mission_number = 0
        self.mission_list = []

        self.map_structure = []  # 0: empty, 1-9: worker, -1 wall
        for i in range(100):
            self.map_structure.append([0]*100)

        self.all_route_wide = [] # 保存所有工作台之间的路线
        self.all_route_thin = []
        self.needed_route0 = [(16,20),(22,20),(20,9),(11,12),(18,12),(12,9),(14,13),(15,13),(13,9),(9,7)]
        self.needed_route1 = []
        self.needed_route2 = []
        self.needed_route3 = []

        self.utile = utile()

        self.total_frame = 15000

        # TODO 最后几秒的判断
        self.more_time = 0.2

        self.map_id = 2

    def read_route(self):
        # TODO
        lines_thin = [[(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,44),(68,46),(70,46),(16,20)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(76,42),(78,44),(78,48),(82,52),(82,56),(86,60),(86,68),(94,76),(94,80),(92,82),(88,82),(86,84),(88,86),(92,86),(96,90),(98,88),(98,72),(94,68),(98,64),(98,60),(94,56),(98,52),(94,48),(98,44),(98,32),(94,28),(94,20),(98,16),(96,14),(92,14),(88,10),(84,14),(82,12),(82,8),(84,6),(88,6),(90,4),(88,2),(78,2),(16,21)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(16,9)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(16,11)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(16,12)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(63,49),(62,49),(16,18)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(16,14)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(16,13)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(16,15)],
                    [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(16,7)],
                    [(70,46),(68,46),(66,44),(68,42),(76,42),(78,44),(78,48),(82,52),(82,56),(86,60),(86,68),(94,76),(94,80),(92,82),(88,82),(86,84),(88,86),(92,86),(96,90),(98,88),(98,72),(94,68),(98,64),(98,60),(94,56),(98,52),(94,48),(98,44),(98,32),(94,28),(94,20),(98,16),(96,14),(92,14),(88,10),(84,14),(82,12),(82,8),(84,6),(88,6),(90,4),(88,2),(78,2),(20,21)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(20,9)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(20,11)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(20,12)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(63,49),(62,49),(20,18)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(20,14)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(20,13)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(20,15)],
                    [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(20,7)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(21,9)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(21,11)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(21,12)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(63,49),(62,49),(21,18)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(21,14)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(21,13)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(21,15)],
                    [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(21,7)],
                    [(30,46),(32,46),(36,42),(40,42),(42,40),(42,38),(9,11)],
                    [(30,46),(32,46),(34,48),(34,56),(36,58),(38,56),(38,52),(40,50),(42,50),(9,12)],
                    [(30,46),(32,46),(34,48),(34,56),(36,58),(38,56),(38,52),(40,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(9,18)],
                    [(30,46),(32,46),(34,48),(34,56),(36,58),(52,58),(54,60),(54,62),(9,14)],
                    [(30,46),(32,46),(34,48),(34,56),(36,58),(44,58),(46,60),(46,62),(9,13)],
                    [(30,46),(32,46),(34,48),(34,56),(36,58),(44,58),(50,64),(50,68),(54,72),(9,15)],
                    [(30,46),(32,46),(34,44),(32,42),(22,42),(9,7)],
                    [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(38,56),(38,52),(40,50),(42,50),(11,12)],
                    [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(38,56),(38,52),(40,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(11,18)],
                    [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(52,58),(54,60),(54,62),(11,14)],
                    [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(44,58),(46,60),(46,62),(11,13)],
                    [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(44,58),(50,64),(50,68),(54,72),(11,15)],
                    [(42,38),(42,40),(40,42),(22,42),(11,7)],
                    [(42,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(12,18)],
                    [(42,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(12,14)],
                    [(42,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(12,13)],
                    [(42,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(12,15)],
                    [(42,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(12,7)],
                    [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(18,14)],
                    [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(18,13)],
                    [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(18,15)],
                    [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(18,7)],
                    [(54,62),(54,60),(52,58),(48,58),(46,60),(46,62),(14,13)],
                    [(54,62),(54,60),(52,58),(48,58),(46,60),(50,64),(50,68),(54,72),(14,15)],
                    [(54,62),(54,60),(52,58),(36,58),(34,56),(34,44),(32,42),(22,42),(14,7)],
                    [(46,62),(48,62),(50,64),(50,68),(54,72),(13,15)],
                    [(46,62),(46,60),(44,58),(36,58),(34,56),(34,44),(32,42),(22,42),(13,7)],
                    [(54,72),(50,68),(50,64),(44,58),(36,58),(34,56),(34,44),(32,42),(22,42),(15,7)]]

        for l in lines_thin:
            route = l
            tmp = route[-1]
            route = route[:-1]
            if route != []:
                self.all_route_thin[tmp[0]][tmp[1]] = route
                self.all_route_thin[tmp[1]][tmp[0]] = route[::-1]

        # TODO
        lines_wide = [[(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,44),(68,46),(70,46),(16,20)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(76,42),(78,44),(78,48),(82,52),(82,56),(86,60),(86,68),(94,76),(94,80),(92,82),(88,82),(86,84),(88,86),(92,86),(96,90),(98,88),(98,72),(94,68),(98,64),(98,60),(94,56),(98,52),(94,48),(98,44),(98,32),(94,28),(94,20),(98,16),(96,14),(92,14),(88,10),(84,14),(82,12),(82,8),(84,6),(88,6),(90,4),(88,2),(78,2),(16,21)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(16,9)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(16,11)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(16,12)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(63,49),(62,49),(16,18)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(16,14)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(16,13)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(16,15)],
                        [(61,30),(60,30),(58,28),(60,26),(68,26),(70,28),(70,32),(66,36),(66,40),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(16,7)],
                        [(70,46),(68,46),(66,44),(68,42),(76,42),(78,44),(78,48),(82,52),(82,56),(86,60),(86,68),(94,76),(94,80),(92,82),(88,82),(86,84),(88,86),(92,86),(96,90),(98,88),(98,72),(94,68),(98,64),(98,60),(94,56),(98,52),(94,48),(98,44),(98,32),(94,28),(94,20),(98,16),(96,14),(92,14),(88,10),(84,14),(82,12),(82,8),(84,6),(88,6),(90,4),(88,2),(78,2),(20,21)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(20,9)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(20,11)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(20,12)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(63,49),(62,49),(20,18)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(20,14)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(20,13)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(20,15)],
                        [(70,46),(68,46),(66,44),(68,42),(72,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(20,7)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,48),(32,46),(30,46),(21,9)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(36,42),(40,42),(42,40),(42,38),(21,11)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(42,50),(21,12)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(63,49),(62,49),(21,18)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(21,14)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(21,13)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(21,15)],
                        [(78,2),(88,2),(90,4),(88,6),(84,6),(82,8),(82,12),(84,14),(88,10),(92,14),(96,14),(98,16),(94,20),(94,28),(98,32),(98,44),(94,48),(98,52),(94,56),(98,60),(98,64),(94,68),(98,72),(98,88),(96,90),(92,86),(88,86),(86,84),(88,82),(92,82),(94,80),(94,76),(86,68),(86,60),(82,56),(82,52),(78,48),(78,44),(76,42),(74,44),(74,48),(68,54),(62,48),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(21,7)],
                        [(30,46),(32,46),(36,42),(40,42),(42,40),(42,38),(9,11)],
                        [(30,46),(32,46),(34,48),(34,56),(36,58),(38,56),(38,52),(40,50),(42,50),(9,12)],
                        [(30,46),(32,46),(34,48),(34,56),(36,58),(38,56),(38,52),(40,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(9,18)],
                        [(30,46),(32,46),(34,48),(34,56),(36,58),(52,58),(54,60),(54,62),(9,14)],
                        [(30,46),(32,46),(34,48),(34,56),(36,58),(44,58),(46,60),(46,62),(9,13)],
                        [(30,46),(32,46),(34,48),(34,56),(36,58),(44,58),(50,64),(50,68),(54,72),(9,15)],
                        [(30,46),(32,46),(34,44),(32,42),(22,42),(9,7)],
                        [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(38,56),(38,52),(40,50),(42,50),(11,12)],
                        [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(38,56),(38,52),(40,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(11,18)],
                        [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(52,58),(54,60),(54,62),(11,14)],
                        [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(44,58),(46,60),(46,62),(11,13)],
                        [(42,38),(42,40),(40,42),(36,42),(34,44),(34,56),(36,58),(44,58),(50,64),(50,68),(54,72),(11,15)],
                        [(42,38),(42,40),(40,42),(22,42),(11,7)],
                        [(42,50),(56,50),(58,48),(58,44),(60,42),(62,44),(62,49),(12,18)],
                        [(42,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(12,14)],
                        [(42,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(12,13)],
                        [(42,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(12,15)],
                        [(42,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(12,7)],
                        [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(52,58),(54,60),(54,62),(18,14)],
                        [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(46,60),(46,62),(18,13)],
                        [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(40,58),(44,58),(50,64),(50,68),(54,72),(18,15)],
                        [(62,49),(62,44),(60,42),(58,44),(58,48),(56,50),(40,50),(38,52),(38,56),(36,58),(34,56),(34,44),(32,42),(22,42),(18,7)],
                        [(54,62),(54,60),(52,58),(48,58),(46,60),(46,62),(14,13)],
                        [(54,62),(54,60),(52,58),(48,58),(46,60),(50,64),(50,68),(54,72),(14,15)],
                        [(54,62),(54,60),(52,58),(36,58),(34,56),(34,44),(32,42),(22,42),(14,7)],
                        [(46,62),(48,62),(50,64),(50,68),(54,72),(13,15)],
                        [(46,62),(46,60),(44,58),(36,58),(34,56),(34,44),(32,42),(22,42),(13,7)],
                        [(54,72),(50,68),(50,64),(44,58),(36,58),(34,56),(34,44),(32,42),(22,42),(15,7)]]

        for l in lines_wide:
            route = l
            tmp = route[-1]
            route = route[:-1]
            if route != []:
                self.all_route_wide[tmp[0]][tmp[1]] = route
                self.all_route_wide[tmp[1]][tmp[0]] = route[::-1]

    def get_route(self, worker_id_list, save_path):
        # TODO
        wide_route_list = []
        thin_route_list = []
        length = len(worker_id_list)
        for i in range(length-1):
            for j in range(i+1,length):
                route_wide = self.utile.find_route(worker_id_list[i], worker_id_list[j], self.worker_list, self.map_structure, wide=1)
                route_wide.append((worker_id_list[i],worker_id_list[j]))
                wide_route_list.append(route_wide)

                route_thin = self.utile.find_route(worker_id_list[i], worker_id_list[j], self.worker_list, self.map_structure, wide=0)
                route_thin.append((worker_id_list[i], worker_id_list[j]))
                thin_route_list.append(route_thin)

        wide_route_txt = open("wide_" + save_path, "w")
        wide_route_txt.write("[")
        for route in wide_route_list:
            tmp = []
            for i in route:
                tmp.append("({},{})".format(i[0], i[1]))
            wide_route_txt.write("[" + ",".join(tmp) + "]," + "\n")
        wide_route_txt.write("]")
        wide_route_txt.close()

        thin_route_txt = open("thin_" + save_path, "w")
        thin_route_txt.write("[")
        for route in thin_route_list:
            tmp = []
            for i in route:
                tmp.append("({},{})".format(i[0], i[1]))
            thin_route_txt.write("[" + ",".join(tmp) + "]," + "\n")
        thin_route_txt.write("]")
        thin_route_txt.close()
    
    def get_worker_id_list(self):
        needed_route = self.needed_route0 + self.needed_route1 + self.needed_route2 + self.needed_route3
        wil = []
        for p in needed_route:
            for w in p:
                if w not in wil:
                    wil.append(w)
        return wil

    def read_map(self):
        # 此处读入地图，并进行预处理
        position_x = 0.25
        position_y = 49.75
        line = input()
        while line != "OK":
            for i in line:
                # 机器人类型
                if i == "A":
                    new_robot = robot(id=self.robot_number, px=position_x, py=position_y)
                    self.robot_list.append(new_robot)
                    self.robot_number += 1
                
                # 工作台类型
                elif i in "123456789":
                    gx,gy = self.utile.meter2grid(position_x, position_y)
                    self.map_structure[gx][gy] = int(i)
                    new_worker = worker(id=self.worker_number, px=position_x, py=position_y, gx=gx, gy=gy, worker_type=int(i))
                    self.worker_list.append(new_worker)
                    self.worker_group_list[int(i)].append(new_worker.id)
                    self.worker_number += 1
                
                elif i == "#":
                    gx,gy = self.utile.meter2grid(position_x, position_y)
                    self.map_structure[gx][gy] = -1

                position_x += 0.5
            position_x = 0.25
            position_y -= 0.5
            line = input()
        
        # 读入地图后进行一些预先处理，目前all route什么也没有记录
        for i in range(self.worker_number):
            self.all_route_wide.append([0]*self.worker_number)
            self.all_route_thin.append([0]*self.worker_number)
        self.pre_calculate() 

    def robot_process(self):
        """
        # 1. 让机器人知道自己可以到达的工作台的集合
        # 2. 让机器人知道自己和哪些机器人是可以一起工作的
        """
        for roboti in self.robot_list:
            rgx, rgy = roboti.gx, roboti.gy
            rbti_d_type = self.utile.get_domain_type(rgx,rgy,self.utile.connected_domain_wide)
            for workeri in self.worker_list:
                wgx, wgy = workeri.grid_x, workeri.grid_y
                wkr_d_type = self.utile.get_domain_type(wgx,wgy,self.utile.connected_domain_wide)
                if wkr_d_type == rbti_d_type:
                    roboti.reachable_worker_id_list.append(workeri.id)

            for robotj in self.robot_list:
                rbtj_d_type = self.utile.get_domain_type(robotj.gx, robotj.gy, self.utile.connected_domain_wide)
                if rbtj_d_type==rbti_d_type:
                    roboti.neighbor_robot_id_list.append(robotj.id)


    def pre_calculate(self):
        '''
        TODO 目前针对地图1
        系统初始化时，每个机器人选择他们的任务系统
        只需要更新self.robot_list的中robot的状态即可
        '''
        self.utile.initialize(self.map_structure)
        
        route_path = "route.txt"
        # 1. get all possible route and save them in route_path
        worker_id_list = self.get_worker_id_list()
        # self.get_route(worker_id_list, route_path)

        # 2. read all path from route_path to self.all_route
        self.read_route()

        # 3. use self.needed_route0 to create a mission
        new_mission0 = mission_system(id=0)
        new_mission0.initialize_special(self.needed_route0, self.all_route_thin, self.all_route_wide, self.utile)
        self.mission_list.append(new_mission0)
        self.mission_number += 1

        # 4. use self.needed_route1 to create a mission
        # new_mission1 = mission_system(id=1)
        # new_mission1.initialize_special(self.needed_route1, self.all_route_thin, self.all_route_wide, self.utile)
        # self.mission_list.append(new_mission1)
        # self.mission_number += 1

        
        # add robot 0 to mission 0
        self.robot_list[0].die = 0
        self.robot_list[0].in_task = 0
        self.robot_list[0].mission_system_id = 0
        new_mission0.robot_id_list.append(0)

        # add robot 1 to mission 1
        self.robot_list[1].die = 0
        self.robot_list[1].in_task = 0
        self.robot_list[1].mission_system_id = 0
        new_mission0.robot_id_list.append(1)

        # add robot 2 to mission 0
        self.robot_list[2].die = 0
        self.robot_list[2].in_task = 0
        self.robot_list[2].mission_system_id = 0
        new_mission0.robot_id_list.append(2)

        # add robot 3 to mission 0
        self.robot_list[3].die = 0
        self.robot_list[3].in_task = 0
        self.robot_list[3].mission_system_id = 0
        new_mission0.robot_id_list.append(3)
        


    def add_new_frame(self, frame_id, money):
        new_frame = frame_statement(id=frame_id, money=money)
        worker_number = int(input())
        # 读取工作台的状态
        for index in range(worker_number):
            line = input()
            parts = line.split(" ")
            self.worker_list[index].update_statement(parts)
            new_frame.worker_statement.append(parts)

        # 读取机器人的状态
        for index in range(self.robot_number):
            line = input()
            parts = line.split(" ")
            self.robot_list[index].update_statement(parts)
            new_frame.robot_statement.append(parts)
        
        self.frame_number += 1
        self.frame_list.append(new_frame)
        if self.frame_number > 1:
            old_frame = self.frame_list[self.frame_number-2]
            self.frame_list[self.frame_number-2] = 0
            del old_frame
            
        # TODO debug专用断点，可以在任何帧停下来
        if frame_id in [2207]:
            pause = 1
        ok = input()
        if ok != "OK":
            raise RuntimeError
    
    def print_out_instruction(self):
        '''
        # FIXME 
        # 此时决策模块已经完成
        # 根据机器人领取的任务，得到每个机器人的行动指令，并输出
        '''
        # 根据函数decision中每个机器人得到的任务，得到机器人的执行指令，并放入frame_statement中
        for roboti in self.robot_list:
            if roboti.die == 1 or roboti.in_task == 0:
                # 表示该机器人处于无任务状态，应该发出指令，停止机器人运行
                self.stop_robot(roboti)
            else:
                self.instruct_robot(roboti)

        sys.stdout.write('%d\n' % self.frame_number)
        current_frame_instructions = self.frame_list[self.frame_number - 1].instructions
        for instruction in current_frame_instructions:
            sys.stdout.write(instruction)

    def stop_robot(self, roboti):
        '''
        # FIXME 将停止机器人运行的指令放入frame_statement中
        注意指令为一个字符串，以\n结尾
        '''
        # 此时应该要让机器人停止
        # if roboti.production_tpye != 0:
        #     raise RuntimeError
        
        # 添加指令到当前帧中
        current_frame = self.frame_list[self.frame_number - 1]
        current_frame.instructions.append("forward " + str(int(roboti.id)) + " 0\n") # 前进速度为0
        current_frame.instructions.append("rotate " + str(int(roboti.id)) + " 0\n") # 旋转速度为0


    def instruct_robot(self, roboti):
        '''
        # FIXME 针对机器人目前执行的任务，将相应指令放入frame_statement中 很多细节没有验证
        注意指令为一个字符串，以\n结尾
        '''
        current_frame = self.frame_list[self.frame_number - 1]
        total_instructions = []
        if roboti.production_tpye==0:
            # 1. 机器人执行route0
            if roboti.near_worker_id != roboti.task[0]:
                if roboti.is_start == 1:
                    roboti.is_start = 0
                    inst = roboti.go_along_route(roboti.route0, 1, self.robot_list, self.map_structure, self.frame_number, self.map_id)
                else:
                    inst = roboti.go_along_route(roboti.route0, 0, self.robot_list, self.map_structure, self.frame_number, self.map_id)
                total_instructions += inst
            else:
                # 买了东西后先停止
                if (self.worker_list[roboti.task[0]].production_flag == 0 or self.worker_list[roboti.task[0]].reserve_production_flag == 0) and self.worker_list[roboti.task[0]].worker_type not in [1,2,3]:
                    # 没有买到，说明运动模块出现了问题
                    raise RuntimeError
                else:
                    flag = self.time_enough(roboti.id, roboti.task[1])
                    if flag == 1:
                        total_instructions.append("buy {}\n".format(int(roboti.id)))
                        roboti.go_back_step = 1
                        roboti.go_back_steps = [1, 1, 1, 1]
                        total_instructions.append("forward {} 0\n".format(int(roboti.id)))
                        total_instructions.append("rotate {} 0\n".format(int(roboti.id)))
                        self.worker_list[roboti.task[0]].reserve_production_flag = 0
                        self.worker_list[roboti.task[0]].production_flag = 0
                        roboti.is_start = 1 # 目前已经处于route1的起点
                    else:
                        total_instructions.append("forward {} 0\n".format(int(roboti.id)))
                        total_instructions.append("rotate {} 0\n".format(int(roboti.id)))                        

        else:
            # 2. 机器人执行route1
            if roboti.near_worker_id != roboti.task[1]:
                if roboti.is_start == 1:
                    roboti.is_start = 0
                    inst = roboti.go_along_route(roboti.route1, 1, self.robot_list, self.map_structure, self.frame_number, self.map_id)
                else:
                    inst = roboti.go_along_route(roboti.route1, 0, self.robot_list, self.map_structure, self.frame_number, self.map_id)
                total_instructions += inst
            else:
                # 卖出东西后先停止
                total_instructions.append("sell {}\n".format(int(roboti.id)))
                roboti.go_back_step = 1
                roboti.go_back_steps = [1, 1, 1, 1]
                total_instructions.append("forward {} 0\n".format(int(roboti.id)))
                total_instructions.append("rotate {} 0\n".format(int(roboti.id)))
                if self.worker_list[roboti.task[1]].worker_type in [8,9]:
                    self.worker_list[roboti.task[1]].raw_materials[roboti.production_tpye] = [1,0,0]
                else:
                    self.worker_list[roboti.task[1]].raw_materials[roboti.production_tpye] = [1,1,0]
                roboti.in_task = 0


        # 将控制roboti的指令加入total_instructions中
        current_frame.instructions += total_instructions

    def time_enough(self, robot_id, destination_worker_id):
        '''
        判断机器人买下成品后，是否有足够时间送到
        假设为最快速度+0.5s之内可以到达，则任务可以到达
        '''

        roboti = self.robot_list[robot_id]
        route = self.all_route_wide[roboti.near_worker_id][destination_worker_id]
        distance = 0
        length = len(route)
        for i in range(1,length):
            s = route[i-1]
            e = route[i]
            distance += ((s[0]-e[0])**2 + (s[1]-e[1])**2)**0.5
        
        if (distance / 8) * 50 + self.more_time < self.total_frame - self.frame_number:
            return 1
        return 0


    def decision(self):
        '''
        # TODO 决策模块
        在该模块执行完成以后，机器人如果处于没有任务的状态，则应该停止运行
        如果机器人处于有任务的状态，则应该针对它的任务输出相应的指令
        '''
        for roboti in self.robot_list:
            if roboti.die == 1:
                continue
            else:
                if roboti.in_task == 1:
                    continue
                else:
                    current_mission = self.mission_list[roboti.mission_system_id]
                    # 1.1 任务系统给出当前最合适的任务
                    # 这里开始时可能会进行路径搜索，会发生卡顿
                    task, route1 = current_mission.get_task(self.worker_list, self.map_structure, self.all_route_wide)
                    if task == -1:
                        # 机器人会继续等
                        continue
                    else:
                        # 1.2 需要知道机器人如何到达start工作台
                        route0 = -1
                        if roboti.near_worker_id != -1:
                            if self.all_route_thin[roboti.near_worker_id][task[0]] != 0 and self.all_route_thin[roboti.near_worker_id][task[0]] != []:
                                route0 = self.all_route_thin[roboti.near_worker_id][task[0]]

                        if route0 == -1:
                            # 没有现成的路径，需要找一条新路
                            start_x, start_y = self.utile.meter2grid(roboti.position_x, roboti.position_y)
                            end_x, end_y = self.utile.meter2grid(self.worker_list[task[0]].position_x, self.worker_list[task[0]].position_y)

                            # FIXME 假定一定可以找到，这里非常消耗时间
                            route0 = self.utile.find_route_thin(start_x, start_y, end_x, end_y, self.map_structure)

                            # 检查是否需要记录该路径
                            if roboti.near_worker_id != -1:
                                self.all_route_thin[roboti.near_worker_id][task[0]] = route0
                                self.all_route_thin[task[0]][roboti.near_worker_id] = route0[::-1]

                        roboti.transport_production(task, route0, route1)
                        
                        

